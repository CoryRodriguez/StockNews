---
phase: 02-signal-engine
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/prisma/migrations/20260228000001_add_bot_signal_log/migration.sql
  - backend/package.json
  - backend/src/config.ts
autonomous: true
requirements:
  - SIG-07
  - SIG-11

must_haves:
  truths:
    - "prisma.botSignalLog.create() is callable from TypeScript with the full field set documented in the research"
    - "Running `npm install` in backend/ installs @anthropic-ai/sdk without errors"
    - "config.anthropicApiKey resolves from ANTHROPIC_API_KEY env var; falls back to empty string when absent"
    - "config.claudeSignalModel is a string constant ('claude-haiku-4-5-20251022') accessible from any service file"
    - "TypeScript compiles clean — zero new errors from schema or config changes"
  artifacts:
    - path: "backend/prisma/schema.prisma"
      provides: "BotSignalLog model with all evaluation audit fields"
      contains: "model BotSignalLog"
    - path: "backend/prisma/migrations/20260228000001_add_bot_signal_log/migration.sql"
      provides: "CREATE TABLE statement for bot_signal_log"
      contains: "CREATE TABLE"
    - path: "backend/package.json"
      provides: "@anthropic-ai/sdk dependency"
      contains: "@anthropic-ai/sdk"
    - path: "backend/src/config.ts"
      provides: "anthropicApiKey and claudeSignalModel config fields"
      contains: "anthropicApiKey"
  key_links:
    - from: "backend/src/services/signalEngine.ts"
      to: "prisma.botSignalLog"
      via: "Prisma generated client after prisma generate"
      pattern: "botSignalLog\\.create"
    - from: "backend/src/services/signalEngine.ts"
      to: "config.anthropicApiKey"
      via: "import from ../config"
      pattern: "config\\.anthropicApiKey"
---

<objective>
Add the BotSignalLog database model and the @anthropic-ai/sdk dependency — the two foundational pieces that Plan 02-02 and 02-03 build on.

Purpose: Every signal evaluation must write a permanent audit record (SIG-07). The Claude API call (SIG-11) requires the SDK installed before signalEngine.ts can import it. Both must exist before any signal engine code can be written.

Output: BotSignalLog Prisma model + migration SQL; @anthropic-ai/sdk in package.json; anthropicApiKey + claudeSignalModel constants in config.ts.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-signal-engine/02-RESEARCH.md

@.planning/phases/01-bot-infrastructure-foundation/01-01-SUMMARY.md
@.planning/phases/01-bot-infrastructure-foundation/01-02-SUMMARY.md
</context>

<interfaces>
<!-- Key contracts the executor needs. Extracted from codebase. -->

From backend/prisma/schema.prisma (existing bot models for reference):
```prisma
model BotTrade {
  id             String    @id @default(cuid())
  symbol         String
  status         String
  // ... (existing — do NOT modify)
}

model BotConfig {
  id                       String   @id @default("singleton")
  // ... (existing — do NOT modify)
}

model BotDailyStats {
  id            String   @id @default(cuid())
  date          String
  // ... (existing — do NOT modify)
}
```

From backend/src/config.ts (existing pattern to follow):
```typescript
// Config object uses process.env lookups with ?? fallback
export const config = {
  alpacaApiKey: process.env.ALPACA_API_KEY ?? "",
  alpacaApiSecret: process.env.ALPACA_API_SECRET ?? "",
  alpacaPaperUrl: "https://paper-api.alpaca.markets",
  alpacaLiveUrl: "https://api.alpaca.markets",  // added in Phase 1
  // ... other fields
};
```

Target BotSignalLog model (from research — implement exactly this):
```prisma
model BotSignalLog {
  id               String    @id @default(cuid())
  symbol           String
  source           String    // "rtpr" | "benzinga" | "alpaca"
  headline         String    @db.Text
  catalystCategory String?
  catalystTier     Int?
  outcome          String    // "fired" | "rejected" | "skipped"
  rejectReason     String?   // "not-running" | "stale" | "reconnect-cooldown" | "duplicate" |
                             // "market-closed" | "opening-auction" | "tier-disabled" |
                             // "danger-pattern" | "below-win-rate" | "failed-5-pillars" |
                             // "ai-declined" | "ai-timeout" | "log-only" | "ai-unavailable"
  failedPillar     String?   // "price" | "relative_volume" — when rejectReason = "failed-5-pillars"
  aiProceed        Boolean?
  aiConfidence     String?   // "high" | "medium" | "low"
  aiReasoning      String?   @db.Text
  winRateAtEval    Float?
  priceAtEval      Float?
  relVolAtEval     Float?
  articleCreatedAt DateTime?
  evaluatedAt      DateTime  @default(now())

  @@index([symbol])
  @@index([outcome])
  @@index([evaluatedAt])
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add BotSignalLog model to schema.prisma + migration SQL</name>
  <files>
    backend/prisma/schema.prisma
    backend/prisma/migrations/20260228000001_add_bot_signal_log/migration.sql
  </files>
  <action>
    1. Open backend/prisma/schema.prisma. Append the BotSignalLog model block after the BotDailyStats model. Use the exact model definition from the interfaces section above. Add a schema comment above it:
       `// BotSignalLog — one record per evaluated news article; outcome: "fired" | "rejected" | "skipped"`

    2. Create directory backend/prisma/migrations/20260228000001_add_bot_signal_log/ and write migration.sql with:

    ```sql
    -- CreateTable
    CREATE TABLE "BotSignalLog" (
        "id" TEXT NOT NULL,
        "symbol" TEXT NOT NULL,
        "source" TEXT NOT NULL,
        "headline" TEXT NOT NULL,
        "catalystCategory" TEXT,
        "catalystTier" INTEGER,
        "outcome" TEXT NOT NULL,
        "rejectReason" TEXT,
        "failedPillar" TEXT,
        "aiProceed" BOOLEAN,
        "aiConfidence" TEXT,
        "aiReasoning" TEXT,
        "winRateAtEval" DOUBLE PRECISION,
        "priceAtEval" DOUBLE PRECISION,
        "relVolAtEval" DOUBLE PRECISION,
        "articleCreatedAt" TIMESTAMP(3),
        "evaluatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

        CONSTRAINT "BotSignalLog_pkey" PRIMARY KEY ("id")
    );

    -- CreateIndex
    CREATE INDEX "BotSignalLog_symbol_idx" ON "BotSignalLog"("symbol");

    -- CreateIndex
    CREATE INDEX "BotSignalLog_outcome_idx" ON "BotSignalLog"("outcome");

    -- CreateIndex
    CREATE INDEX "BotSignalLog_evaluatedAt_idx" ON "BotSignalLog"("evaluatedAt");
    ```

    3. Run `cd c:/Projects/StockNews/backend && npx prisma validate` to confirm schema is valid.

    4. Run `cd c:/Projects/StockNews/backend && npx prisma generate` to regenerate the Prisma client with BotSignalLog types. On Windows, this may warn about DLL file lock — that is expected and non-fatal.
  </action>
  <verify>
    cd c:/Projects/StockNews/backend && npx prisma validate
    Output must exit 0 with no errors.
    Then confirm: grep -c "BotSignalLog" prisma/schema.prisma — must return 3+ (model declaration + indexes).
  </verify>
  <done>schema.prisma contains BotSignalLog model; migration.sql exists; prisma validate exits 0; prisma generate succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Install @anthropic-ai/sdk and add config constants</name>
  <files>
    backend/package.json
    backend/src/config.ts
  </files>
  <action>
    1. Install the Anthropic SDK:
       `cd c:/Projects/StockNews/backend && npm install @anthropic-ai/sdk`
       This adds @anthropic-ai/sdk to dependencies in package.json.

    2. Open backend/src/config.ts. Add two new fields to the config object, after the existing alpaca fields:

    ```typescript
    anthropicApiKey: process.env.ANTHROPIC_API_KEY ?? "",
    claudeSignalModel: "claude-haiku-4-5-20251022",
    ```

    Place them in a logical group — after `alpacaLiveUrl`. The model ID is a constant string so it can be updated in one place if Anthropic releases a newer Haiku.

    3. Confirm TypeScript compiles:
       `cd c:/Projects/StockNews/backend && npx tsc --noEmit`
       Zero new errors expected. If config.ts has type issues from the new fields, resolve them (the existing pattern is plain string/property assignment, no typing issues expected).

    IMPORTANT: Do NOT read or modify .env files. Document in user_setup that ANTHROPIC_API_KEY must be added to backend/.env and docker-compose.yml by the user.
  </action>
  <verify>
    cd c:/Projects/StockNews/backend && npx tsc --noEmit
    Output: zero TypeScript errors.
    Also verify: grep "anthropicApiKey" src/config.ts — returns a match.
    And: grep "@anthropic-ai/sdk" package.json — returns a match.
  </verify>
  <done>@anthropic-ai/sdk in package.json dependencies; config.ts exports anthropicApiKey (from ANTHROPIC_API_KEY env) and claudeSignalModel string constant; tsc --noEmit is clean.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `cd c:/Projects/StockNews/backend && npx prisma validate` — exits 0
2. `cd c:/Projects/StockNews/backend && npx tsc --noEmit` — zero errors
3. `grep -l "BotSignalLog" backend/prisma/schema.prisma` — file found
4. `grep "@anthropic-ai/sdk" backend/package.json` — match found
5. `grep "anthropicApiKey" backend/src/config.ts` — match found
</verification>

<success_criteria>
- BotSignalLog model is present in schema.prisma with all 17 fields and 3 indexes
- Migration SQL file exists at the correct path
- prisma generate completed (Prisma client has BotSignalLog types)
- @anthropic-ai/sdk is listed in backend/package.json dependencies
- config.ts has anthropicApiKey and claudeSignalModel constants
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-signal-engine/02-01-SUMMARY.md` following the summary template.
</output>
