---
phase: 02-signal-engine
plan: "04"
type: execute
wave: 4
depends_on:
  - "02-03"
files_modified: []
autonomous: false
requirements:
  - SIG-01
  - SIG-02
  - SIG-03
  - SIG-04
  - SIG-05
  - SIG-06
  - SIG-07
  - SIG-08
  - SIG-09
  - SIG-10
  - SIG-11

must_haves:
  truths:
    - "BotSignalLog rows appear in the database when the server is running and news articles arrive"
    - "The server starts without TypeScript or runtime errors"
    - "Signal logs show varied rejection reasons across real article traffic: stale, tier-disabled, failed-5-pillars, log-only"
    - "No orders are placed — BotTrade table has no new rows created by signal engine activity"
  artifacts:
    - path: "backend/src/services/signalEngine.ts"
      provides: "Complete signal evaluation pipeline"
      exports: ["evaluateBotSignal", "notifyReconnect"]
    - path: "backend/prisma/schema.prisma"
      provides: "BotSignalLog model"
      contains: "model BotSignalLog"
  key_links:
    - from: "rtpr.ts / alpacaNews.ts / benzinga.ts"
      to: "signalEngine.evaluateBotSignal"
      via: "fire-and-forget call after executePaperTrade"
      pattern: "evaluateBotSignal\\(article\\)"
    - from: "signalEngine.ts"
      to: "prisma.botSignalLog"
      via: "writeSignalLog() helper"
      pattern: "botSignalLog\\.create"
---

<objective>
Verify the complete Phase 2 Signal Engine pipeline end-to-end: server starts cleanly, BotSignalLog rows are written, no orders are placed, and the implementation is complete.

Purpose: The signal engine runs silently in production until Phase 3. This checkpoint confirms the foundation is solid before Phase 3 wires in order execution.

Output: Confirmed working signal evaluation pipeline. Phase 2 complete.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-signal-engine/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run automated verification suite</name>
  <files></files>
  <action>
    Run the following checks in order. Fix any failures before proceeding to the human checkpoint.

    1. Schema validation:
       `cd c:/Projects/StockNews/backend && npx prisma validate`
       Must exit 0.

    2. TypeScript compile:
       `cd c:/Projects/StockNews/backend && npx tsc --noEmit`
       Must exit 0 with zero errors.

    3. Verify all three news services are hooked:
       `grep -l "evaluateBotSignal" backend/src/services/rtpr.ts backend/src/services/alpacaNews.ts backend/src/services/benzinga.ts`
       All 3 files must appear.

    4. Verify signal engine does NOT touch BotTrade (Phase 3's responsibility):
       `grep "botTrade\|BotTrade" backend/src/services/signalEngine.ts`
       Must return NO output.

    5. Verify "log-only" is used for fired signals (no order placement):
       `grep "log-only" backend/src/services/signalEngine.ts`
       Must return at least 2 matches (tier 1-2 fast path + AI-approved path).

    6. Verify Benzinga does not call notifyReconnect (it is a REST poller):
       `grep "notifyReconnect" backend/src/services/benzinga.ts`
       Must return NO output.
  </action>
  <verify>
    cd c:/Projects/StockNews/backend && npx prisma validate && npx tsc --noEmit
    Both commands exit 0.
  </verify>
  <done>All 6 automated checks pass: schema valid, TypeScript clean, all 3 services hooked, signal engine never touches BotTrade, log-only present, benzinga has no notifyReconnect.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — server starts and signal pipeline is wired</name>
  <files></files>
  <action>
    This checkpoint verifies the complete Phase 2 Signal Engine end-to-end. No code changes needed — observer verification only.

    What was built across Plans 02-01 through 02-03:
    - BotSignalLog Prisma model (17 fields, 3 indexes) + migration SQL
    - signalEngine.ts with 11-step evaluation gauntlet (state gate, market hours, reconnect cooldown, staleness, dedup, tier check, opening auction, win-rate, 5 Pillars, Claude AI branch)
    - @anthropic-ai/sdk installed; config.ts has anthropicApiKey and claudeSignalModel
    - evaluateBotSignal hooked into rtpr.ts, alpacaNews.ts, benzinga.ts (unconditional, fire-and-forget)
    - notifyReconnect wired into RTPR and AlpacaNews WebSocket on-open handlers

    Steps to observe the pipeline working:
    1. Start the backend: `cd c:/Projects/StockNews/backend && npm run dev`
       Confirm it starts without errors. No "[SignalEngine]" error messages expected at startup.

    2. During market hours with bot started (POST /api/bot/start):
       - Wait 30-60 seconds for news articles from RTPR, Benzinga, or AlpacaNews
       - Check the database BotSignalLog table for rows
       - Expect rows with varied rejectReasons (stale, tier-disabled, failed-5-pillars, log-only)

    3. Outside market hours (when isMarketOpen() = false):
       - Signal engine silently skips all articles — no BotSignalLog rows written
       - This is correct behavior per the pipeline spec

    4. Verify no new BotTrade rows from signal engine activity — BotTrade is untouched until Phase 3.

    Note: ANTHROPIC_API_KEY must be set in backend/.env for tier 3-4 articles to reach Claude API.
    Without the key, tier 3-4 articles log rejectReason="ai-unavailable" — this is graceful fallback behavior.
  </action>
  <verify>
    Server starts cleanly: `cd c:/Projects/StockNews/backend && npm run dev` exits with listening message, no crash.
  </verify>
  <done>Server starts cleanly; user confirms implementation looks correct and Phase 2 is approved.</done>
  <what-built>
    Complete Phase 2 Signal Engine across 4 plans:
    - BotSignalLog Prisma model with 17 fields and 3 indexes
    - signalEngine.ts with 11-step evaluation gauntlet
    - @anthropic-ai/sdk + config.ts constants
    - All 3 news services hooked with fire-and-forget evaluateBotSignal calls
    - RTPR and AlpacaNews WebSocket reconnect notifications wired
  </what-built>
  <how-to-verify>
    Start backend server, watch logs for clean startup, optionally query BotSignalLog table during market hours to observe signal evaluation records.
  </how-to-verify>
  <resume-signal>
    Type "approved" if the server starts cleanly and the implementation looks correct.
    Describe any issues (TypeScript errors, server crash, unexpected behavior) if not approved.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 2 complete when:
1. `npx prisma validate` exits 0
2. `npx tsc --noEmit` exits 0
3. All 11 SIG requirements addressed across the four plans
4. Human checkpoint approved
</verification>

<success_criteria>
- Server starts without errors
- BotSignalLog table exists in the database (migration applied)
- evaluateBotSignal called for every article from all 3 sources
- No orders placed during Phase 2 — BotTrade untouched by signal engine
- TypeScript compiles clean across all modified files
- Phase 2 checkpoint approved by user
</success_criteria>

<output>
After completion, create `.planning/phases/02-signal-engine/02-04-SUMMARY.md` following the summary template.
Also update STATE.md: current_phase=02, status=Phase 2 Complete.
</output>
