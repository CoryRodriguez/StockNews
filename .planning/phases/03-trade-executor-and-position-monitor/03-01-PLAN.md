---
phase: 03-trade-executor-and-position-monitor
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/prisma/migrations/20260228000002_add_bot_config_sizing_fields/migration.sql
autonomous: true
requirements:
  - EXEC-05
  - EXEC-07

must_haves:
  truths:
    - "BotConfig has tradeSizeStars3, tradeSizeStars4, tradeSizeStars5 fields for flat-dollar sizing"
    - "BotConfig has profitTargetPct field for profit target exit condition"
    - "prisma generate succeeds without errors after schema change"
    - "Migration SQL file exists and is syntactically valid"
  artifacts:
    - path: "backend/prisma/schema.prisma"
      provides: "Updated BotConfig model with 4 new fields"
      contains: "tradeSizeStars3"
    - path: "backend/prisma/migrations/20260228000002_add_bot_config_sizing_fields/migration.sql"
      provides: "SQL to add 4 columns to BotConfig table"
      contains: "ALTER TABLE"
  key_links:
    - from: "backend/prisma/schema.prisma BotConfig.tradeSizeStars3"
      to: "backend/src/services/botController.ts BotConfigRecord"
      via: "prisma generate regenerates the Prisma client types"
      pattern: "tradeSizeStars3"
---

<objective>
Add four missing fields to the BotConfig Prisma schema and create the migration SQL to apply them to the database. This unblocks all Phase 3 executor code which depends on star-rating sizing (EXEC-07) and profit target configuration (EXIT-03).

Purpose: The existing BotConfig table has `hardStopLossPct`, `maxHoldDurationSec`, and `positionSizeUsd` but is missing the star-rating flat amounts and profit target that CONTEXT.md locked in. Writing executor code against absent fields causes TypeScript errors or silent undefined reads.

Output: Updated schema.prisma + migration SQL file. No runtime code changes yet.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-trade-executor-and-position-monitor/CONTEXT.md
@.planning/phases/03-trade-executor-and-position-monitor/03-RESEARCH.md

<interfaces>
<!-- Current BotConfig in schema.prisma (fields that already exist): -->
```prisma
model BotConfig {
  id                       String   @id @default("singleton")
  enabled                  Boolean  @default(false)
  state                    String   @default("stopped")
  mode                     String   @default("paper")
  positionSizeUsd          Float    @default(500)
  confidenceMultiplierHigh Float    @default(2.0)
  confidenceMultiplierMed  Float    @default(1.0)
  confidenceMultiplierLow  Float    @default(0.5)
  maxConcurrentPositions   Int      @default(3)
  dailyLossLimitUsd        Float    @default(500)
  minWinRate               Float    @default(0.5)
  hardStopLossPct          Float    @default(7.0)
  maxHoldDurationSec       Int      @default(300)
  enabledCatalystTiers     String   @default("1,2,3,4")
  maxFloatShares           Float    @default(20000000)
  maxSharePrice            Float    @default(20)
  minRelativeVolume        Float    @default(5)
  updatedAt                DateTime @updatedAt
}
```

<!-- Current BotConfigRecord interface in botController.ts (must stay in sync): -->
```typescript
export interface BotConfigRecord {
  id: string;
  enabled: boolean;
  state: string;
  mode: string;
  positionSizeUsd: number;
  confidenceMultiplierHigh: number;
  confidenceMultiplierMed: number;
  confidenceMultiplierLow: number;
  maxConcurrentPositions: number;
  dailyLossLimitUsd: number;
  minWinRate: number;
  hardStopLossPct: number;
  maxHoldDurationSec: number;
  enabledCatalystTiers: string;
  maxFloatShares: number;
  maxSharePrice: number;
  minRelativeVolume: number;
  updatedAt: Date;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sizing fields to BotConfig schema and update BotConfigRecord</name>
  <files>backend/prisma/schema.prisma, backend/src/services/botController.ts</files>
  <action>
Add four new fields to the BotConfig model in schema.prisma immediately after the existing `minRelativeVolume` line and before `updatedAt`:

```prisma
  tradeSizeStars3          Float    @default(50)
  tradeSizeStars4          Float    @default(75)
  tradeSizeStars5          Float    @default(100)
  profitTargetPct          Float    @default(10)
```

Defaults match CONTEXT.md: 3-star=$50, 4-star=$75, 5-star=$100, profit target=10%.

ALSO update `BotConfigRecord` interface in `backend/src/services/botController.ts` to add matching TypeScript fields after `minRelativeVolume`:

```typescript
  tradeSizeStars3: number;
  tradeSizeStars4: number;
  tradeSizeStars5: number;
  profitTargetPct: number;
```

Do NOT modify the `create` block in `initBot()` yet — that happens in Plan 03-04.

NOTE: Do NOT run `prisma db push` or any migration command. The migration SQL is created manually in Task 2 and applied by the executor only after review. The Prisma client will be regenerated after the migration is written.
  </action>
  <verify>
    <automated>cd C:/Projects/StockNews/backend && rtk tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>schema.prisma has all four new fields with correct Float types and defaults; BotConfigRecord has four matching number fields; tsc --noEmit passes (no TypeScript errors from schema mismatch)</done>
</task>

<task type="auto">
  <name>Task 2: Create migration SQL file for new BotConfig columns</name>
  <files>backend/prisma/migrations/20260228000002_add_bot_config_sizing_fields/migration.sql</files>
  <action>
Create the directory `backend/prisma/migrations/20260228000002_add_bot_config_sizing_fields/` and write `migration.sql` with the following content exactly:

```sql
-- Migration: add star-rating sizing fields and profitTargetPct to BotConfig
-- Phase 3: Trade Executor and Position Monitor

ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "tradeSizeStars3" DOUBLE PRECISION NOT NULL DEFAULT 50;
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "tradeSizeStars4" DOUBLE PRECISION NOT NULL DEFAULT 75;
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "tradeSizeStars5" DOUBLE PRECISION NOT NULL DEFAULT 100;
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "profitTargetPct" DOUBLE PRECISION NOT NULL DEFAULT 10;
```

Use `IF NOT EXISTS` to make the migration safe to run multiple times (idempotent), matching the pattern established in the Phase 1 migration.

After writing the file, run `prisma generate` to regenerate the Prisma client with the new fields:

```bash
cd C:/Projects/StockNews/backend && rtk npx prisma generate
```

Then apply the migration to the database:

```bash
cd C:/Projects/StockNews/backend && rtk npx prisma migrate resolve --applied 20260228000002_add_bot_config_sizing_fields 2>/dev/null || true
rtk npx prisma db execute --file ./prisma/migrations/20260228000002_add_bot_config_sizing_fields/migration.sql --schema ./prisma/schema.prisma
```

NOTE: The migration applies directly via `db execute` (same pattern as Phases 1 and 2) rather than `migrate deploy` — this is consistent with the project's established migration strategy for manual SQL files.
  </action>
  <verify>
    <automated>cd C:/Projects/StockNews/backend && rtk npx prisma validate 2>&1 && echo "SCHEMA_VALID" && test -f prisma/migrations/20260228000002_add_bot_config_sizing_fields/migration.sql && echo "MIGRATION_EXISTS"</automated>
  </verify>
  <done>migration.sql file exists with four ALTER TABLE statements; prisma validate passes; prisma generate succeeds; new columns queryable from Prisma client (BotConfigRecord.tradeSizeStars3 resolves without TypeScript error)</done>
</task>

</tasks>

<verification>
Run both checks to confirm plan is complete:
1. `cd C:/Projects/StockNews/backend && rtk npx prisma validate` — should print "Prisma schema validated successfully"
2. `cd C:/Projects/StockNews/backend && rtk tsc --noEmit` — should produce no errors
3. `test -f C:/Projects/StockNews/backend/prisma/migrations/20260228000002_add_bot_config_sizing_fields/migration.sql && echo OK` — file must exist
</verification>

<success_criteria>
- BotConfig model in schema.prisma has tradeSizeStars3 (Float default 50), tradeSizeStars4 (Float default 75), tradeSizeStars5 (Float default 100), profitTargetPct (Float default 10)
- BotConfigRecord TypeScript interface has matching number fields
- Migration SQL file exists with four IF NOT EXISTS ALTER TABLE statements
- prisma validate passes
- tsc --noEmit passes
- New columns exist in the database (verified by prisma db execute completing without error)
</success_criteria>

<output>
After completion, create `.planning/phases/03-trade-executor-and-position-monitor/03-01-SUMMARY.md`
</output>
