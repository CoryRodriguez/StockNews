---
phase: 03-trade-executor-and-position-monitor
plan: "05"
type: execute
wave: 4
depends_on:
  - "03-04"
files_modified: []
autonomous: false
requirements:
  - EXEC-02
  - EXEC-03
  - EXEC-04
  - EXIT-01
  - EXIT-03
  - EXIT-04
  - EXIT-05
  - EXIT-06

must_haves:
  truths:
    - "tsc --noEmit passes with zero errors across the entire backend"
    - "prisma validate passes with no schema errors"
    - "All five new/modified files are present and contain the required exports"
    - "signalEngine.ts contains zero occurrences of log-only"
    - "positionMonitor.ts contains the weekday-only EOD cron pattern"
    - "tradeExecutor.ts contains the notional buy order (not qty)"
    - "tradingWs.ts connects to a mode-aware URL derived from getAlpacaBaseUrl()"
    - "Human confirms the full bot startup sequence is working end-to-end"
  artifacts:
    - path: "backend/src/services/tradeExecutor.ts"
      provides: "Notional buy order + BotTrade lifecycle"
      exports: ["executeTradeAsync", "onFillEvent", "onRejectedEvent"]
    - path: "backend/src/services/tradingWs.ts"
      provides: "Trading WebSocket connection"
      exports: ["startTradingWs", "restartTradingWs"]
    - path: "backend/src/services/positionMonitor.ts"
      provides: "Exit loop + EOD cron"
      exports: ["startPositionMonitor", "addPosition", "removePosition"]
    - path: "backend/src/services/signalEngine.ts"
      provides: "Signal engine with live executor calls"
      contains: "executeTradeAsync"
    - path: "backend/src/services/botController.ts"
      provides: "Reconciliation + startup hydration"
      contains: "addPosition"
    - path: "backend/src/index.ts"
      provides: "Startup wiring"
      contains: "startTradingWs"
  key_links:
    - from: "backend/src/services/signalEngine.ts fired branch"
      to: "backend/src/services/tradeExecutor.ts executeTradeAsync"
      via: "void executeTradeAsync().catch()"
      pattern: "void executeTradeAsync"
    - from: "backend/src/services/tradingWs.ts handleTradingWsMessage"
      to: "backend/src/services/tradeExecutor.ts onFillEvent"
      via: "onFillEvent() called on fill/partial_fill events"
      pattern: "onFillEvent"
    - from: "backend/src/services/botController.ts reconcilePositions"
      to: "backend/src/services/positionMonitor.ts addPosition"
      via: "called for every open BotTrade + every orphan on startup"
      pattern: "addPosition"
---

<objective>
Run the complete automated verification suite for Phase 3 and present a human verification checkpoint. All 12 requirements in scope for Phase 3 (EXEC-01 through EXEC-07, EXIT-01, EXIT-03 through EXIT-06) must have automated evidence before the human checkpoint. EXIT-02 (trailing stop) is deferred to Phase 4 and is NOT verified here.

Purpose: Phase 3 is the first phase that places real orders. The verification must confirm the code compiles, the wiring is present, and all critical patterns are correct — before the user declares the phase complete.

Output: Verification results written to VERIFICATION.md; human approval or issues surfaced.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-trade-executor-and-position-monitor/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run automated verification suite and write VERIFICATION.md</name>
  <files>.planning/phases/03-trade-executor-and-position-monitor/VERIFICATION.md</files>
  <action>
Run all checks and collect results. Write a VERIFICATION.md to the phase directory. A check PASSES or FAILS — record both.

**Check 1 — TypeScript compilation:**
```bash
cd C:/Projects/StockNews/backend && rtk tsc --noEmit 2>&1
```
PASS = zero errors output. FAIL = any TypeScript error lines.

**Check 2 — Prisma schema valid:**
```bash
cd C:/Projects/StockNews/backend && rtk npx prisma validate 2>&1
```
PASS = "Prisma schema validated successfully". FAIL = any error.

**Check 3 — New files exist:**
```bash
test -f C:/Projects/StockNews/backend/src/services/tradeExecutor.ts && echo PASS || echo FAIL
test -f C:/Projects/StockNews/backend/src/services/tradingWs.ts && echo PASS || echo FAIL
test -f C:/Projects/StockNews/backend/src/services/positionMonitor.ts && echo PASS || echo FAIL
test -f C:/Projects/StockNews/backend/prisma/migrations/20260228000002_add_bot_config_sizing_fields/migration.sql && echo PASS || echo FAIL
```

**Check 4 — log-only removed from signalEngine:**
```bash
grep -c '"log-only"' C:/Projects/StockNews/backend/src/services/signalEngine.ts
```
PASS = output is `0`. FAIL = any other number.

**Check 5 — Fire-and-forget executor calls in signalEngine:**
```bash
grep -c "void executeTradeAsync" C:/Projects/StockNews/backend/src/services/signalEngine.ts
```
PASS = output is `2` (one per fired branch). FAIL = anything else.

**Check 6 — Notional (not qty) in buy order:**
```bash
grep "notional:" C:/Projects/StockNews/backend/src/services/tradeExecutor.ts | head -5
grep '"qty"' C:/Projects/StockNews/backend/src/services/tradeExecutor.ts | grep "buy" | head -5
```
PASS = notional appears; no qty in buy order body. FAIL = notional absent or qty used for buy.

**Check 7 — Mode-aware trading WebSocket URL:**
```bash
grep "getAlpacaBaseUrl" C:/Projects/StockNews/backend/src/services/tradingWs.ts | head -5
grep '"/stream"' C:/Projects/StockNews/backend/src/services/tradingWs.ts | head -5
```
PASS = getAlpacaBaseUrl referenced in URL construction + /stream path. FAIL = hardcoded paper URL.

**Check 8 — sold guard in positionMonitor:**
```bash
grep -c "pos.sold" C:/Projects/StockNews/backend/src/services/positionMonitor.ts
```
PASS = count >= 2. FAIL = 0 or 1.

**Check 9 — EOD cron weekday-only with timezone:**
```bash
grep "45 15 \* \* 1-5" C:/Projects/StockNews/backend/src/services/positionMonitor.ts
grep "America/New_York" C:/Projects/StockNews/backend/src/services/positionMonitor.ts
```
PASS = both strings found. FAIL = either missing.

**Check 10 — Startup wiring in index.ts:**
```bash
grep "startTradingWs\|startPositionMonitor" C:/Projects/StockNews/backend/src/index.ts
```
PASS = both strings found. FAIL = either missing.

**Check 11 — addPosition called in reconcilePositions:**
```bash
grep "addPosition" C:/Projects/StockNews/backend/src/services/botController.ts
```
PASS = at least one occurrence. FAIL = zero.

**Check 12 — New BotConfig fields in initBot create block:**
```bash
grep "tradeSizeStars3\|tradeSizeStars4\|tradeSizeStars5\|profitTargetPct" C:/Projects/StockNews/backend/src/services/botController.ts
```
PASS = all four strings found. FAIL = any missing.

**Check 13 — Star-rating sizing reads BotConfig (not hardcoded):**
```bash
grep "tradeSizeStars" C:/Projects/StockNews/backend/src/services/tradeExecutor.ts | head -5
```
PASS = references cfg.tradeSizeStars fields. FAIL = hardcoded numbers like `50` or `75` or `100`.

Write results to:
`C:/Projects/StockNews/.planning/phases/03-trade-executor-and-position-monitor/VERIFICATION.md`

Format:
```markdown
# Phase 3 Verification Results

Date: [today]

| Check | Description | Result |
|-------|-------------|--------|
| 1 | TypeScript compilation | PASS/FAIL |
| 2 | Prisma schema valid | PASS/FAIL |
| 3 | New files exist | PASS/FAIL |
| 4 | log-only removed from signalEngine | PASS/FAIL |
| 5 | void executeTradeAsync x2 in signalEngine | PASS/FAIL |
| 6 | Notional (not qty) in buy order | PASS/FAIL |
| 7 | Mode-aware trading WS URL | PASS/FAIL |
| 8 | sold guard in positionMonitor (>=2) | PASS/FAIL |
| 9 | EOD cron weekday-only + timezone | PASS/FAIL |
| 10 | startTradingWs + startPositionMonitor in index.ts | PASS/FAIL |
| 11 | addPosition in reconcilePositions | PASS/FAIL |
| 12 | New BotConfig fields in initBot create | PASS/FAIL |
| 13 | Star-rating reads BotConfig not hardcoded | PASS/FAIL |

**Summary:** N/13 checks passed

Note: EXIT-02 (trailing stop) is not verified here — officially deferred to Phase 4 per user decision.

[List any FAIL items with the actual output that indicated failure]
```
  </action>
  <verify>
    <automated>test -f C:/Projects/StockNews/.planning/phases/03-trade-executor-and-position-monitor/VERIFICATION.md && echo "VERIFICATION_WRITTEN"</automated>
  </verify>
  <done>VERIFICATION.md exists with all 13 checks recorded; any failures are clearly documented with actual output</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 3 complete — the autonomous trading bot now places real paper-mode orders:

- tradeExecutor.ts: star-rating sizing (3/4/5-star = $50/$75/$100), notional buy orders, BotTrade lifecycle
- tradingWs.ts: Alpaca trading WebSocket for real-time fill/partial_fill/rejected events
- positionMonitor.ts: 5s exit loop (hard stop, profit target, time exit) + 3:45 PM ET EOD force-close
- signalEngine.ts: fires executeTradeAsync instead of logging "log-only"
- botController.ts: orphan position import + positionMonitor hydration on startup
- index.ts: startTradingWs() + startPositionMonitor() added to startup sequence
- BotConfig migration: tradeSizeStars3/4/5 + profitTargetPct fields added
- EXIT-02 (trailing stop): deferred to Phase 4; peakPrice tracking groundwork is in place
  </what-built>
  <how-to-verify>
1. Review VERIFICATION.md in .planning/phases/03-trade-executor-and-position-monitor/ — confirm all 13 automated checks PASS

2. If the backend is running (or you can start it):
   - Start the bot via `POST /api/bot/start` (or use the existing UI)
   - Confirm `GET /api/bot/status` returns `state: "running"`
   - Watch the backend logs — if a qualifying news article arrives (or test by temporarily lowering signal thresholds), you should see `[TradeExecutor] BUY placed` log lines
   - Confirm `[TradingWs] Authenticated — subscribed to trade_updates` appears in logs on startup

3. Schema confirmation:
   - Verify the database has the new columns (or confirm migration SQL ran without errors)

4. Paper trading only:
   - Confirm `getAlpacaBaseUrl()` returns the paper URL (`paper-api.alpaca.markets`) — mode is 'paper' by default
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
VERIFICATION.md exists with 13/13 checks recorded. Human has approved or issues have been addressed.
</verification>

<success_criteria>
- All 13 automated checks in VERIFICATION.md show PASS
- Human approves the Phase 3 implementation
- No open positions exist that were unintentionally created during verification
</success_criteria>

<output>
After completion, create `.planning/phases/03-trade-executor-and-position-monitor/03-05-SUMMARY.md`
</output>
