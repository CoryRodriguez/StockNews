---
phase: 04-risk-management-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/prisma/migrations/20260228000003_add_trailing_stop_fields/migration.sql
  - backend/src/services/botController.ts
autonomous: true
requirements:
  - EXIT-02
must_haves:
  truths:
    - "BotConfig schema has trailingStopPct and trailingStopDollar fields with default 0"
    - "BotConfigRecord TypeScript interface matches the schema (no drift)"
    - "prisma validate passes with no errors"
    - "tsc --noEmit passes with no errors"
  artifacts:
    - path: "backend/prisma/schema.prisma"
      provides: "trailingStopPct Float @default(0), trailingStopDollar Float @default(0) in BotConfig model"
      contains: "trailingStopPct"
    - path: "backend/prisma/migrations/20260228000003_add_trailing_stop_fields/migration.sql"
      provides: "SQL migration adding two columns to BotConfig"
      contains: "ALTER TABLE"
    - path: "backend/src/services/botController.ts"
      provides: "BotConfigRecord interface updated with new fields"
      exports: ["BotConfigRecord", "getTodayDateET"]
  key_links:
    - from: "schema.prisma BotConfig"
      to: "botController.ts BotConfigRecord"
      via: "interface field parity"
      pattern: "trailingStopPct.*number"
---

<objective>
Add `trailingStopPct` and `trailingStopDollar` fields to the BotConfig database schema and TypeScript interface so Phase 4's trailing stop logic (EXIT-02) has configurable parameters.

Purpose: The trailing stop in positionMonitor.ts (Plan 04-03) reads these values from getBotConfig(). Without the schema fields, the values don't exist and positionMonitor has nothing to read.
Output: Updated schema.prisma, new migration SQL, updated BotConfigRecord interface, updated initBot() create defaults.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and existing patterns the executor needs. -->

From backend/src/services/botController.ts (BotConfigRecord — must stay in sync with schema.prisma):
```typescript
export interface BotConfigRecord {
  id: string;
  enabled: boolean;
  state: string;
  mode: string;
  positionSizeUsd: number;
  confidenceMultiplierHigh: number;
  confidenceMultiplierMed: number;
  confidenceMultiplierLow: number;
  maxConcurrentPositions: number;
  dailyLossLimitUsd: number;
  minWinRate: number;
  hardStopLossPct: number;
  maxHoldDurationSec: number;
  enabledCatalystTiers: string;
  maxFloatShares: number;
  maxSharePrice: number;
  minRelativeVolume: number;
  tradeSizeStars3: number;
  tradeSizeStars4: number;
  tradeSizeStars5: number;
  profitTargetPct: number;
  updatedAt: Date;
}
```

Most recent prior migration for reference pattern (20260228000002):
```sql
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "tradeSizeStars3" DOUBLE PRECISION NOT NULL DEFAULT 50;
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "tradeSizeStars4" DOUBLE PRECISION NOT NULL DEFAULT 75;
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "tradeSizeStars5" DOUBLE PRECISION NOT NULL DEFAULT 100;
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "profitTargetPct" DOUBLE PRECISION NOT NULL DEFAULT 10;
```

initBot() upsert create block (must add new fields with defaults):
```typescript
botConfig = await prisma.botConfig.upsert({
  where: { id: 'singleton' },
  update: {},
  create: {
    id: 'singleton',
    // ... all existing fields ...
    profitTargetPct: 10,
    // ADD: trailingStopPct: 0, trailingStopDollar: 0
  },
});
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trailing stop fields to schema.prisma and BotConfigRecord</name>
  <files>backend/prisma/schema.prisma, backend/src/services/botController.ts</files>
  <action>
In backend/prisma/schema.prisma, add two new fields to the BotConfig model, immediately after `profitTargetPct Float @default(10)`:

```prisma
trailingStopPct          Float    @default(0)   // EXIT-02: % trail from peak; 0 = disabled
trailingStopDollar       Float    @default(0)   // EXIT-02: $ trail from peak; 0 = disabled; pct takes precedence when both > 0
```

In backend/src/services/botController.ts:
1. Add two fields to the BotConfigRecord interface, after `profitTargetPct: number`:
   ```typescript
   trailingStopPct: number;
   trailingStopDollar: number;
   ```
2. In the `initBot()` upsert create block, add after `profitTargetPct: 10`:
   ```typescript
   trailingStopPct: 0,
   trailingStopDollar: 0,
   ```

Default 0 means disabled — trailing stop does not fire unless the value is > 0. pct takes precedence when both fields are > 0 (per CONTEXT.md Claude's Discretion).
  </action>
  <verify>cd c:/Projects/StockNews/backend && npx prisma validate 2>&1 | tail -5</verify>
  <done>prisma validate exits 0 with no errors; schema.prisma contains trailingStopPct and trailingStopDollar fields in BotConfig; BotConfigRecord interface has both fields</done>
</task>

<task type="auto">
  <name>Task 2: Create migration SQL for trailing stop fields</name>
  <files>backend/prisma/migrations/20260228000003_add_trailing_stop_fields/migration.sql</files>
  <action>
Create the directory `backend/prisma/migrations/20260228000003_add_trailing_stop_fields/` and write `migration.sql` following the exact pattern of prior migrations (e.g., 20260228000002):

```sql
-- Migration: add trailingStopPct and trailingStopDollar to BotConfig for EXIT-02 trailing stop
-- Default 0 = disabled; pct takes precedence over dollar when both > 0

ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "trailingStopPct"    DOUBLE PRECISION NOT NULL DEFAULT 0;
ALTER TABLE "BotConfig" ADD COLUMN IF NOT EXISTS "trailingStopDollar" DOUBLE PRECISION NOT NULL DEFAULT 0;
```

Do NOT run `prisma migrate` — the VPS deployment applies migration SQL directly. Only create the file.
  </action>
  <verify>cat c:/Projects/StockNews/backend/prisma/migrations/20260228000003_add_trailing_stop_fields/migration.sql</verify>
  <done>migration.sql exists with two ALTER TABLE statements using DOUBLE PRECISION NOT NULL DEFAULT 0</done>
</task>

<task type="auto">
  <name>Task 3: TypeScript compile check</name>
  <files>(no new files — validation only)</files>
  <action>
Run TypeScript compile check to confirm no type drift introduced by the BotConfigRecord change:

```bash
cd c:/Projects/StockNews/backend && npx tsc --noEmit 2>&1
```

If tsc reports errors related to the new fields (e.g., "trailingStopPct does not exist on type"), check that:
1. The BotConfigRecord interface was updated in botController.ts
2. The Prisma client was regenerated (run `npx prisma generate` if the client doesn't reflect new schema fields)
  </action>
  <verify>cd c:/Projects/StockNews/backend && npx tsc --noEmit 2>&1; echo "exit=$?"</verify>
  <done>tsc --noEmit exits 0 with no TypeScript errors</done>
</task>

</tasks>

<verification>
```bash
# 1. Schema validates
cd c:/Projects/StockNews/backend && npx prisma validate

# 2. New fields present in schema
grep -n "trailingStop" c:/Projects/StockNews/backend/prisma/schema.prisma

# 3. Interface updated
grep -n "trailingStop" c:/Projects/StockNews/backend/src/services/botController.ts

# 4. Migration file exists
ls c:/Projects/StockNews/backend/prisma/migrations/20260228000003_add_trailing_stop_fields/migration.sql

# 5. TypeScript clean
cd c:/Projects/StockNews/backend && npx tsc --noEmit
```
</verification>

<success_criteria>
- schema.prisma BotConfig model has trailingStopPct and trailingStopDollar (both Float @default(0))
- BotConfigRecord interface in botController.ts has both fields as number
- initBot() create block includes both fields with value 0
- Migration SQL file exists at 20260228000003_add_trailing_stop_fields/migration.sql
- prisma validate passes
- tsc --noEmit passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-risk-management-enforcement/04-01-SUMMARY.md` with:
- What was changed (schema fields, interface update, migration SQL)
- Key decisions made
- Any issues encountered
- Commit hash(es)
</output>
