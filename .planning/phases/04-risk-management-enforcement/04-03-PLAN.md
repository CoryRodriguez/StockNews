---
phase: 04-risk-management-enforcement
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - backend/src/services/positionMonitor.ts
autonomous: true
requirements:
  - EXIT-02
  - RISK-04
must_haves:
  truths:
    - "Trailing stop fires when currentPrice falls below peakPrice * (1 - trailingStopPct/100) when trailingStopPct > 0"
    - "Dollar trailing stop fires when currentPrice falls below peakPrice - trailingStopDollar when only trailingStopDollar > 0"
    - "Percentage trailing stop takes precedence over dollar trailing stop when both are configured > 0"
    - "Hard stop (EXIT-01) is still checked BEFORE trailing stop (EXIT-02) — order preserved"
    - "4AM ET cron runs Monday-Friday and logs a daily reset message"
    - "getOpenPositionCount() and getOpenSymbols() are exported for signalEngine.ts (Plan 04-02) to import"
    - "tsc --noEmit passes with no errors after both Plan 04-02 and Plan 04-03 are complete"
  artifacts:
    - path: "backend/src/services/positionMonitor.ts"
      provides: "EXIT-02 trailing stop in checkExitConditions(); 4AM cron; getOpenPositionCount and getOpenSymbols exports"
      exports: ["startPositionMonitor", "addPosition", "removePosition", "getOpenPositionCount", "getOpenSymbols"]
  key_links:
    - from: "positionMonitor.ts checkExitConditions()"
      to: "BotConfig.trailingStopPct and BotConfig.trailingStopDollar"
      via: "getBotConfig() call"
      pattern: "trailingStopPct|trailingStopDollar"
    - from: "positionMonitor.ts"
      to: "scheduleEodForceClose()"
      via: "cron.schedule('0 4 * * 1-5', ..., { timezone: 'America/New_York' })"
      pattern: "0 4 \\* \\* 1-5"
---

<objective>
Wire the trailing stop (EXIT-02) into positionMonitor.ts's checkExitConditions() using the peakPrice already tracked, add the 4AM daily reset cron (RISK-04), and export getOpenPositionCount/getOpenSymbols for signalEngine.ts (Plan 04-02) to import.

Purpose: peakPrice has been tracked since Phase 3 but never triggered an exit. Plan 04-03 replaces the "DEFERRED TO PHASE 4" placeholder with real exit logic. The 4AM cron completes the daily counter lifecycle. The exported functions enable Plan 04-02's risk gates without a circular dependency.
Output: positionMonitor.ts with EXIT-02 logic, RISK-04 cron, and two new exports.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

<interfaces>
<!-- Key contracts the executor needs. Extracted from codebase. -->

From backend/src/services/positionMonitor.ts — current checkExitConditions() (insertion points annotated):

```typescript
async function checkExitConditions(pos: TrackedPosition, currentPrice: number): Promise<void> {
  if (pos.sold) return;

  // Update peak for future trailing stop (EXIT-02, deferred to Phase 4)
  if (currentPrice > pos.peakPrice) pos.peakPrice = currentPrice;

  const cfg = getBotConfig();
  const pctChange = (currentPrice - pos.entryPrice) / pos.entryPrice * 100;
  const holdMinutes = (Date.now() - pos.entryAt.getTime()) / 60000;
  const maxHoldMinutes = cfg.maxHoldDurationSec / 60;

  // EXIT-01: Hard stop loss (stopLossPct is a positive number, e.g. 7 means -7%)
  if (pctChange <= -cfg.hardStopLossPct) {
    await closePosition(pos, currentPrice, 'hard_stop');
    return;
  }
  // EXIT-03: Profit target                   ← INSERT EXIT-02 BETWEEN EXIT-01 AND EXIT-03
  if (pctChange >= cfg.profitTargetPct) {
    await closePosition(pos, currentPrice, 'profit_target');
    return;
  }
  // EXIT-04: Max hold time
  if (holdMinutes >= maxHoldMinutes) {
    await closePosition(pos, currentPrice, 'time_exit');
    return;
  }
  // EXIT-02: Trailing stop — DEFERRED TO PHASE 4 per user decision
  // peakPrice is tracked above as groundwork only — no exit logic here
  //   ^^^^ REMOVE THIS COMMENT AND REPLACE WITH REAL LOGIC
}
```

From backend/src/services/botController.ts — BotConfigRecord (after Plan 04-01 adds new fields):
```typescript
export interface BotConfigRecord {
  // ... existing fields ...
  trailingStopPct: number;    // 0 = disabled; > 0 = percentage from peak
  trailingStopDollar: number; // 0 = disabled; > 0 = dollar from peak; pct wins if both > 0
}
```

From backend/src/services/positionMonitor.ts — current scheduleEodForceClose() pattern to follow:
```typescript
function scheduleEodForceClose(): void {
  cron.schedule('45 15 * * 1-5', async () => {
    console.log('[PositionMonitor] EOD force-close at 3:45 PM ET');
    // ... force close logic
  }, { timezone: 'America/New_York' });
  console.log('[PositionMonitor] EOD force-close cron scheduled (3:45 PM ET, Mon-Fri)');
}
```

Current exports from positionMonitor.ts:
```typescript
export function startPositionMonitor(): void  // schedules EOD cron — will also schedule 4AM cron
export function addPosition(pos: Omit<TrackedPosition, 'sold'>): void
export function removePosition(tradeId: string): void
// ADD: export function getOpenPositionCount(): number
// ADD: export function getOpenSymbols(): Set<string>
```

Cron scheduling pitfall (from RESEARCH.md): Add a module-level boolean guard to prevent
duplicate cron registration if startPositionMonitor() is ever called twice:
```typescript
let cronsScheduled = false;
export function startPositionMonitor(): void {
  if (cronsScheduled) return;
  cronsScheduled = true;
  scheduleEodForceClose();
  scheduleDailyReset();
  console.log('[PositionMonitor] Started — polling every 5s, EOD close at 3:45 PM ET, daily reset at 4:00 AM ET');
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire EXIT-02 trailing stop logic into checkExitConditions</name>
  <files>backend/src/services/positionMonitor.ts</files>
  <action>
In `checkExitConditions()`, REPLACE the placeholder comment at the end:
```typescript
  // EXIT-02: Trailing stop — DEFERRED TO PHASE 4 per user decision
  // peakPrice is tracked above as groundwork only — no exit logic here
```

WITH actual trailing stop exit logic:
```typescript
  // EXIT-02: Trailing stop — fires when price falls below peak by configured amount
  // Hard stop (EXIT-01) runs first — provides absolute floor for fast crashes.
  // Trailing stop is secondary protection that locks in gains as price rises.
  // pct takes precedence over dollar when both are configured > 0 (CONTEXT.md Claude's Discretion).
  // Note: after server restart, peakPrice is reset to entryPrice (known limitation — hard stop still protects).
  const trailPct    = cfg.trailingStopPct;    // 0 = disabled
  const trailDollar = cfg.trailingStopDollar; // 0 = disabled

  if (trailPct > 0) {
    // Percentage trailing stop takes precedence
    const stopPrice = pos.peakPrice * (1 - trailPct / 100);
    if (currentPrice <= stopPrice) {
      await closePosition(pos, currentPrice, 'trailing_stop');
      return;
    }
  } else if (trailDollar > 0) {
    // Dollar trailing stop — only when pct is not configured (= 0)
    const stopPrice = pos.peakPrice - trailDollar;
    if (currentPrice <= stopPrice) {
      await closePosition(pos, currentPrice, 'trailing_stop');
      return;
    }
  }
```

Also UPDATE the comment at the top of `checkExitConditions()` that previously said:
```
// Update peak for future trailing stop (EXIT-02, deferred to Phase 4)
```
Change to:
```
// Update peak price — used by EXIT-02 trailing stop below
```

And UPDATE the file-level JSDoc comment block at the top of positionMonitor.ts to remove the "EXIT-02 is deferred" line and replace with:
```
 *   EXIT-02: Trailing stop (configurable via BotConfig.trailingStopPct / trailingStopDollar)
```
  </action>
  <verify>grep -n "trailing_stop\|trailPct\|trailDollar\|trailingStop" c:/Projects/StockNews/backend/src/services/positionMonitor.ts</verify>
  <done>positionMonitor.ts checkExitConditions() contains trailing stop logic with both pct and dollar branches; exitReason 'trailing_stop' is passed to closePosition</done>
</task>

<task type="auto">
  <name>Task 2: Add 4AM daily reset cron and export position count helpers</name>
  <files>backend/src/services/positionMonitor.ts</files>
  <action>
Add the following changes to positionMonitor.ts:

**1. Add a module-level guard boolean** near the top of the file (after the `openPositions` Map declaration):
```typescript
let cronsScheduled = false; // guard against duplicate cron registration on multiple startPositionMonitor() calls
```

**2. Add a `scheduleDailyReset()` function** after `scheduleEodForceClose()`:
```typescript
// ── 4AM daily reset cron (RISK-04) ───────────────────────────────────────────

function scheduleDailyReset(): void {
  cron.schedule('0 4 * * 1-5', async () => {
    console.log('[PositionMonitor] 4AM daily reset — clearing in-memory daily state');
    // No circuit breaker to clear (RISK-01 removed per user decision).
    // BotDailyStats rows are date-keyed: a new upsert on the first trade of the day
    // creates a fresh row automatically — no explicit zeroing needed here.
    // This cron exists to: (1) log the day boundary for debugging, (2) clear any
    // future in-memory counters without requiring a server restart.
    console.log('[PositionMonitor] Daily reset complete');
  }, { timezone: 'America/New_York' });
  console.log('[PositionMonitor] Daily reset cron scheduled (4:00 AM ET, Mon-Fri)');
}
```

**3. Update `startPositionMonitor()`** to add the cron guard and call both cron schedulers:
```typescript
export function startPositionMonitor(): void {
  if (cronsScheduled) return; // guard: prevent duplicate cron registration
  cronsScheduled = true;
  scheduleEodForceClose();
  scheduleDailyReset();
  console.log('[PositionMonitor] Started — polling every 5s, EOD close at 3:45 PM ET, daily reset at 4:00 AM ET');
}
```

**4. Add two new exported functions** at the end of the "Public API" section (after `removePosition()`):
```typescript
/**
 * Returns the count of currently tracked open positions.
 * Used by signalEngine.ts to enforce RISK-02 max concurrent positions.
 * O(1) — reads in-memory Map size. No DB query needed.
 */
export function getOpenPositionCount(): number {
  return openPositions.size;
}

/**
 * Returns a Set of symbols currently tracked as open positions.
 * Used by signalEngine.ts to enforce RISK-05 per-symbol concentration.
 * O(n) where n = open positions (typically ≤ 5). No DB query needed.
 */
export function getOpenSymbols(): Set<string> {
  return new Set([...openPositions.values()].map(p => p.symbol));
}
```
  </action>
  <verify>grep -n "scheduleDailyReset\|cronsScheduled\|getOpenPositionCount\|getOpenSymbols\|0 4 \* \* 1-5" c:/Projects/StockNews/backend/src/services/positionMonitor.ts</verify>
  <done>positionMonitor.ts has: scheduleDailyReset() function with 4AM cron, cronsScheduled guard in startPositionMonitor(), getOpenPositionCount() exported, getOpenSymbols() exported</done>
</task>

</tasks>

<verification>
```bash
# 1. Trailing stop logic present
grep -n "trailing_stop\|trailPct\|trailDollar" c:/Projects/StockNews/backend/src/services/positionMonitor.ts

# 2. Hard stop still before trailing stop (EXIT-01 order preserved)
grep -n "EXIT-01\|EXIT-02\|EXIT-03\|hard_stop\|trailing_stop\|profit_target" c:/Projects/StockNews/backend/src/services/positionMonitor.ts

# 3. 4AM cron present
grep -n "0 4 \* \* 1-5\|scheduleDailyReset" c:/Projects/StockNews/backend/src/services/positionMonitor.ts

# 4. New exports present
grep -n "export function getOpenPositionCount\|export function getOpenSymbols" c:/Projects/StockNews/backend/src/services/positionMonitor.ts

# 5. Cron guard in startPositionMonitor
grep -n "cronsScheduled" c:/Projects/StockNews/backend/src/services/positionMonitor.ts
```
</verification>

<success_criteria>
- checkExitConditions() has EXIT-02 trailing stop AFTER EXIT-01 (hard stop) and BEFORE EXIT-03 (profit target)
- pct-based trailing stop fires when currentPrice <= peakPrice * (1 - trailPct/100)
- dollar-based trailing stop fires only when trailPct === 0 and trailDollar > 0
- Both default to 0 (disabled) — no existing behavior changes without explicit configuration
- scheduleDailyReset() exists and is called from startPositionMonitor()
- cronsScheduled guard prevents duplicate cron registration
- getOpenPositionCount() and getOpenSymbols() are exported
</success_criteria>

<output>
After completion, create `.planning/phases/04-risk-management-enforcement/04-03-SUMMARY.md` with:
- EXIT-02 implementation details (insertion point, precedence rule, restart limitation note)
- RISK-04 cron details (schedule string, what it does)
- New exports added
- Commit hash(es)
</output>
