---
phase: 04-risk-management-enforcement
plan: 04
type: execute
wave: 3
depends_on:
  - 04-02
  - 04-03
files_modified:
  - backend/src/verification/phase04-checks.sh
autonomous: false
requirements:
  - RISK-02
  - RISK-03
  - RISK-04
  - RISK-05
  - EXIT-02
must_haves:
  truths:
    - "TypeScript compiles clean across all modified files (tsc --noEmit passes)"
    - "All 5 risk gate patterns are present in the codebase (grep verification)"
    - "Trailing stop logic is in the correct position in checkExitConditions (after hard stop)"
    - "Migration SQL file exists with correct column definitions"
    - "User manually confirms the bot can be started in paper mode without errors"
  artifacts:
    - path: "backend/src/verification/phase04-checks.sh"
      provides: "Automated verification script for all Phase 4 requirements"
      contains: "RISK-02"
  key_links:
    - from: "phase04-checks.sh"
      to: "all modified backend files"
      via: "grep pattern checks and tsc compile"
      pattern: "PASS|FAIL"
---

<objective>
Run the Phase 4 automated verification suite (TypeScript compile + pattern checks) and have the user verify the bot starts cleanly in paper mode with no errors.

Purpose: Phases 1-3 all ended with a verification plan that caught real issues before marking the phase complete. Phase 4 follows the same pattern — verify before closing the phase.
Output: Verification script with all checks passing + human confirmation that the bot starts without errors.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-risk-management-enforcement/04-01-SUMMARY.md
@.planning/phases/04-risk-management-enforcement/04-02-SUMMARY.md
@.planning/phases/04-risk-management-enforcement/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run automated verification suite</name>
  <files>backend/src/verification/phase04-checks.sh</files>
  <action>
Create the directory `backend/src/verification/` if it doesn't exist and write `phase04-checks.sh`:

```bash
#!/usr/bin/env bash
# Phase 4: Risk Management Enforcement — Automated Verification
# Run from: c:/Projects/StockNews/backend
set -euo pipefail

PASS=0
FAIL=0

check() {
  local desc="$1"
  local cmd="$2"
  if eval "$cmd" > /dev/null 2>&1; then
    echo "  PASS: $desc"
    ((PASS++))
  else
    echo "  FAIL: $desc"
    ((FAIL++))
  fi
}

echo "=== Phase 4: Risk Management Enforcement Verification ==="
echo ""

echo "--- TypeScript ---"
check "tsc --noEmit passes (no type errors)" "npx tsc --noEmit"

echo ""
echo "--- Schema ---"
check "prisma validate passes" "npx prisma validate"
check "BotConfig has trailingStopPct field" "grep -q 'trailingStopPct' prisma/schema.prisma"
check "BotConfig has trailingStopDollar field" "grep -q 'trailingStopDollar' prisma/schema.prisma"
check "Migration 20260228000003 exists" "test -f prisma/migrations/20260228000003_add_trailing_stop_fields/migration.sql"

echo ""
echo "--- BotConfigRecord Interface (botController.ts) ---"
check "BotConfigRecord has trailingStopPct field" "grep -q 'trailingStopPct: number' src/services/botController.ts"
check "BotConfigRecord has trailingStopDollar field" "grep -q 'trailingStopDollar: number' src/services/botController.ts"

echo ""
echo "--- RISK-02: Max Concurrent Positions (signalEngine.ts) ---"
check "signalEngine imports getOpenPositionCount" "grep -q 'getOpenPositionCount' src/services/signalEngine.ts"
check "signalEngine rejects with max-positions reason" "grep -q \"'max-positions'\" src/services/signalEngine.ts"

echo ""
echo "--- RISK-05: Per-Symbol Concentration (signalEngine.ts) ---"
check "signalEngine imports getOpenSymbols" "grep -q 'getOpenSymbols' src/services/signalEngine.ts"
check "signalEngine rejects with already-holding reason" "grep -q \"'already-holding'\" src/services/signalEngine.ts"

echo ""
echo "--- RISK-03: PDT Enforcement (tradeExecutor.ts) ---"
check "tradeExecutor has checkPdtLimit function" "grep -q 'checkPdtLimit' src/services/tradeExecutor.ts"
check "tradeExecutor has pdt_limit rejection" "grep -q \"'pdt_limit'\" src/services/tradeExecutor.ts"
check "checkPdtLimit returns false for paper mode" "grep -A5 'checkPdtLimit' src/services/tradeExecutor.ts | grep -q 'paper'"
check "PDT check fails open on API error (returns false)" "grep -A10 'checkPdtLimit' src/services/tradeExecutor.ts | grep -q 'return false'"

echo ""
echo "--- RISK-04: Daily Reset Cron (positionMonitor.ts) ---"
check "positionMonitor has 4AM cron schedule" "grep -q '0 4 \* \* 1-5' src/services/positionMonitor.ts"
check "positionMonitor has scheduleDailyReset function" "grep -q 'scheduleDailyReset' src/services/positionMonitor.ts"
check "positionMonitor has cronsScheduled guard" "grep -q 'cronsScheduled' src/services/positionMonitor.ts"

echo ""
echo "--- EXIT-02: Trailing Stop (positionMonitor.ts) ---"
check "positionMonitor has trailing_stop exit reason" "grep -q 'trailing_stop' src/services/positionMonitor.ts"
check "positionMonitor uses trailingStopPct from config" "grep -q 'trailingStopPct' src/services/positionMonitor.ts"
check "positionMonitor uses trailingStopDollar from config" "grep -q 'trailingStopDollar' src/services/positionMonitor.ts"
check "hard_stop appears before trailing_stop (EXIT-01 order)" "awk '/hard_stop/{hard=NR} /trailing_stop/{trail=NR} END{exit !(hard < trail)}' src/services/positionMonitor.ts"

echo ""
echo "--- Exports (positionMonitor.ts) ---"
check "positionMonitor exports getOpenPositionCount" "grep -q 'export function getOpenPositionCount' src/services/positionMonitor.ts"
check "positionMonitor exports getOpenSymbols" "grep -q 'export function getOpenSymbols' src/services/positionMonitor.ts"

echo ""
echo "=================================================="
echo "Results: $PASS passed, $FAIL failed"
echo ""
if [ "$FAIL" -eq 0 ]; then
  echo "ALL CHECKS PASSED — Phase 4 automated verification complete"
  exit 0
else
  echo "FAILURES DETECTED — fix before marking phase complete"
  exit 1
fi
```

Then run it:
```bash
cd c:/Projects/StockNews/backend && bash src/verification/phase04-checks.sh
```

Fix any FAIL items before proceeding to the checkpoint.
  </action>
  <verify>cd c:/Projects/StockNews/backend && bash src/verification/phase04-checks.sh 2>&1; echo "exit=$?"</verify>
  <done>All checks report PASS; script exits 0</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 4 complete — the bot now has:
- RISK-02: Max concurrent positions gate (logs 'max-positions' to BotSignalLog when limit hit)
- RISK-03: PDT enforcement in live mode (blocks trade, logs rejected BotTrade with 'pdt_limit')
- RISK-04: 4AM ET daily reset cron (clears in-memory daily state, logs day boundary)
- RISK-05: Per-symbol concentration gate (logs 'already-holding' to BotSignalLog)
- EXIT-02: Trailing stop wired into positionMonitor (pct and dollar modes, pct takes precedence)
- Schema: trailingStopPct and trailingStopDollar added to BotConfig (default 0 = disabled)
  </what-built>
  <how-to-verify>
1. Start the backend in paper mode:
   ```
   cd c:/Projects/StockNews/backend && npx ts-node src/index.ts
   ```
   (Or via Docker if deployed)

2. Confirm startup logs show:
   - `[BotController] Initialized — state=stopped, mode=paper`
   - `[PositionMonitor] Started — polling every 5s, EOD close at 3:45 PM ET, daily reset at 4:00 AM ET`
   - No TypeScript errors, no unhandled exceptions, no FATAL logs

3. Start the bot via API:
   ```
   curl -X POST http://localhost:3001/api/bot/start
   curl http://localhost:3001/api/bot/status
   ```
   Confirm status shows `state: "running"` with no errors.

4. Optional: Check that the verification script still passes end-to-end:
   ```
   cd c:/Projects/StockNews/backend && bash src/verification/phase04-checks.sh
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if the bot starts clean with no errors, or describe any issues seen in startup logs</resume-signal>
</task>

</tasks>

<verification>
All Phase 4 requirements verified:
- RISK-01: Intentionally NOT implemented (removed per CONTEXT.md locked decision — no daily P&L circuit breaker)
- RISK-02: max-positions gate in signalEngine.ts step 10.5
- RISK-03: PDT check in tradeExecutor.ts (live mode only, fail-open)
- RISK-04: 4AM reset cron in positionMonitor.ts
- RISK-05: already-holding gate in signalEngine.ts step 10.6
- EXIT-02: trailing stop in positionMonitor.ts checkExitConditions (after EXIT-01, before EXIT-03)
</verification>

<success_criteria>
- Verification script: all checks PASS, exit code 0
- Backend starts without errors in paper mode
- Bot can be started via REST API (state transitions to "running")
- No TypeScript errors
- No duplicate cron jobs on startup
</success_criteria>

<output>
After completion, create `.planning/phases/04-risk-management-enforcement/04-04-SUMMARY.md` with:
- Verification results (N/N checks passed)
- Human checkpoint outcome
- Any issues found and fixed during verification
- Commit hash(es)

Then update:
- .planning/STATE.md — Phase 4 complete, ready for Phase 5
- .planning/ROADMAP.md — Phase 4 marked complete, plan count updated
</output>
