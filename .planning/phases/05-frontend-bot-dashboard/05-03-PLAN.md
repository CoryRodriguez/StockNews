---
phase: 05-frontend-bot-dashboard
plan: "05-03"
type: execute
wave: 2
depends_on:
  - "05-01"
  - "05-02"
files_modified:
  - frontend/src/hooks/useSocket.ts
  - frontend/src/pages/Dashboard.tsx
  - frontend/src/store/dashboardStore.ts
autonomous: true
requirements:
  - UI-01
  - UI-02
  - UI-04

must_haves:
  truths:
    - "useSocket.ts subscribes the 'bot' channel after WebSocket connect/reconnect"
    - "useSocket.ts handles bot_status_update and calls setStatus from useBotStore"
    - "useSocket.ts handles bot_trade_closed and calls prependTrade from useBotStore"
    - "useSocket.ts handles bot_signal_evaluated and calls prependSignal from useBotStore"
    - "subscribedRef is cleared on 'connected' message so channels re-subscribe after reconnect"
    - "Dashboard.tsx renderPanel() has a 'bot' case returning <BotPanel />"
    - "dashboardStore.ts DEFAULT_PANELS includes a bot panel entry"
  artifacts:
    - frontend/src/hooks/useSocket.ts
    - frontend/src/pages/Dashboard.tsx
    - frontend/src/store/dashboardStore.ts
  key_links:
    - "useSocket subscribes 'bot' channel; clientHub.ts delivers bot WS messages only to subscribers"
    - "BotPanel.tsx will be created in Plan 05-04 — Dashboard.tsx import is added here first"
---

<objective>
Wire the bot channel into the WebSocket subscription system, fix the subscribedRef reconnect bug, and add BotPanel to the dashboard grid.

Purpose: This plan bridges the backend broadcasts (05-01) and the frontend store (05-02) by connecting them through useSocket.ts. It also registers BotPanel in the dashboard so it appears by default. BotPanel.tsx is created in Plan 05-04 — this plan adds the import and case statement that will compile once 05-04 delivers the file.

Output:
- `frontend/src/hooks/useSocket.ts` — 'bot' channel subscription, three new message handlers, subscribedRef clear fix
- `frontend/src/pages/Dashboard.tsx` — BotPanel import and case in renderPanel()
- `frontend/src/store/dashboardStore.ts` — bot-1 panel in DEFAULT_PANELS
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/05-frontend-bot-dashboard/05-CONTEXT.md
@.planning/phases/05-frontend-bot-dashboard/05-RESEARCH.md

<interfaces>
<!-- Current useSocket.ts structure (must be preserved and extended) -->

Current subscribeChannels (lines 44-57):
```typescript
const subscribeChannels = (ws: WebSocket) => {
  const channels = [
    "news",
    "trades",
    "scanner:news_flow",
    ...Array.from(activeScanners).map((id) => `scanner:${id}`),
  ];
  for (const ch of channels) {
    if (!subscribedRef.current.has(ch)) {
      ws.send(JSON.stringify({ type: "subscribe", channel: ch }));
      subscribedRef.current.add(ch);
    }
  }
};
```

Current "connected" handler (line 65):
```typescript
if (msg.type === "connected") {
  subscribeChannels(ws);  // BUG: subscribedRef not cleared — channels don't re-subscribe after reconnect
}
```

BotStore setters (from Plan 05-02 output):
```typescript
import { useBotStore } from "../store/botStore";
// selectors:
const setStatus   = useBotStore((s) => s.setStatus);
const prependTrade  = useBotStore((s) => s.prependTrade);
const prependSignal = useBotStore((s) => s.prependSignal);
```

WsMessage bot variants (from Plan 05-02 output in types/index.ts):
```typescript
| { type: "bot_status_update"; channel: string; status: { state: string; ... } }
| { type: "bot_trade_closed"; channel: string; trade: { id: string; ... } }
| { type: "bot_signal_evaluated"; channel: string; signal: { id: string; ... } }
```

Current Dashboard.tsx renderPanel() (lines 27-54):
```typescript
function renderPanel(panel: GridPanel) {
  switch (panel.type) {
    case "scanner": ...
    case "chart": ...
    case "news": ...
    case "watchlist": ...
    case "trades": ...
    case "analytics": ...
    default: return null;
  }
}
```

Current DEFAULT_PANELS in dashboardStore.ts (lines 5-12):
```typescript
const DEFAULT_PANELS: GridPanel[] = [
  { id: "scanner-1",   type: "scanner",   scannerId: "news_flow", title: "News Flow",  x: 0, y: 0,  w: 3, h: 14 },
  { id: "scanner-2",   type: "scanner",   scannerId: "gap_up",    title: "Gap Up",     x: 0, y: 14, w: 3, h: 14 },
  { id: "news-1",      type: "news",      newsMode: "firehose",   title: "News Feed",  x: 3, y: 0,  w: 3, h: 28 },
  { id: "chart-1",     type: "chart",     symbol: "NASDAQ:AAPL",                       x: 6, y: 0,  w: 6, h: 16 },
  { id: "watchlist-1", type: "watchlist", title: "Watchlist",                          x: 6, y: 16, w: 6, h: 8  },
  { id: "trades-1",    type: "trades",    title: "Paper Trades",                       x: 6, y: 24, w: 6, h: 4  },
];
// ADD bot-1 entry
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useSocket.ts — bot channel subscription + message handlers + reconnect fix</name>
  <files>frontend/src/hooks/useSocket.ts</files>
  <action>
Open `frontend/src/hooks/useSocket.ts` and make four changes:

**Change 1 — Add botStore imports at the top:**
```typescript
import { useBotStore } from "../store/botStore";
```

**Change 2 — Add botStore selectors inside the useSocket() function body** (alongside the existing `addArticle`, `addAlert`, etc. selectors):
```typescript
const setBotStatus    = useBotStore((s) => s.setStatus);
const prependBotTrade  = useBotStore((s) => s.prependTrade);
const prependBotSignal = useBotStore((s) => s.prependSignal);
```

**Change 3 — Add "bot" to the channels array in subscribeChannels:**
```typescript
const channels = [
  "news",
  "trades",
  "bot",                 // ADD THIS
  "scanner:news_flow",
  ...Array.from(activeScanners).map((id) => `scanner:${id}`),
];
```

**Change 4 — Fix the subscribedRef reconnect bug AND add bot message handlers.**

Replace the `"connected"` handler:
```typescript
// BEFORE:
if (msg.type === "connected") {
  subscribeChannels(ws);
}

// AFTER:
if (msg.type === "connected") {
  subscribedRef.current.clear();  // FIX: clear so all channels re-subscribe after reconnect
  subscribeChannels(ws);
}
```

Then add three new `else if` branches in `handleMessage`, after the existing `"trade_update"` handler:
```typescript
} else if (msg.type === "bot_status_update") {
  setBotStatus(msg.status as Parameters<typeof setBotStatus>[0]);
} else if (msg.type === "bot_trade_closed") {
  prependBotTrade(msg.trade as Parameters<typeof prependBotTrade>[0]);
} else if (msg.type === "bot_signal_evaluated") {
  prependBotSignal(msg.signal as Parameters<typeof prependBotSignal>[0]);
}
```

Also add the three new selectors (`setBotStatus`, `prependBotTrade`, `prependBotSignal`) to the `useEffect` dependency array at line 85:
```typescript
}, [token, activeScanners, addArticle, addAlert, clearAlert, updatePrice, upsertTrade,
    setBotStatus, prependBotTrade, prependBotSignal]);
```
  </action>
  <verify>
    <automated>cd C:/Projects/StockNews/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>tsc --noEmit passes. "bot" is in the channels array. subscribedRef.current.clear() is called before subscribeChannels in the "connected" handler. Three bot message handlers exist in handleMessage.</done>
</task>

<task type="auto">
  <name>Task 2: Add BotPanel to Dashboard.tsx and DEFAULT_PANELS in dashboardStore.ts</name>
  <files>frontend/src/pages/Dashboard.tsx, frontend/src/store/dashboardStore.ts</files>
  <action>
**Dashboard.tsx — two edits:**

Edit 1: Add the BotPanel import at the top with the other panel imports:
```typescript
import { BotPanel } from "../components/panels/BotPanel";
```

Edit 2: Add a `case "bot"` to the `renderPanel()` switch statement before the `default` case:
```typescript
case "bot":
  return <BotPanel />;
```

**dashboardStore.ts — one edit:**

Add a bot-1 entry to `DEFAULT_PANELS`. Place it below the existing `trades-1` entry. Use grid position x:0, y:28, w:6, h:20 to put it in the left column below the scanners:
```typescript
{ id: "bot-1", type: "bot", title: "Bot", x: 0, y: 28, w: 6, h: 20 },
```

IMPORTANT: `BotPanel.tsx` does not exist yet — it will be created in Plan 05-04. The TypeScript import in Dashboard.tsx will cause a compile error until 05-04 completes. This is acceptable — the plans in wave 2 (this plan) and wave 3 (05-04) are sequential by design. If tsc fails ONLY because BotPanel.tsx is missing, note that in the summary and move on. The error will be resolved by Plan 05-04.

If you want to avoid the compile error during this plan, create a minimal stub:
```typescript
// frontend/src/components/panels/BotPanel.tsx (STUB — replaced by Plan 05-04)
export function BotPanel() {
  return <div className="h-full flex flex-col bg-panel overflow-hidden p-2 text-xs font-mono text-muted">Bot Panel — loading...</div>;
}
```
Creating the stub is PREFERRED so tsc passes. Plan 05-04 will fully replace this stub.
  </action>
  <verify>
    <automated>cd C:/Projects/StockNews/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>tsc --noEmit passes (with or without stub). Dashboard.tsx has BotPanel import and case "bot" in renderPanel(). dashboardStore.ts DEFAULT_PANELS includes a bot-1 entry. BotPanel stub (or full component) exists at frontend/src/components/panels/BotPanel.tsx.</done>
</task>

</tasks>

<verification>
Run after both tasks complete:
```bash
cd C:/Projects/StockNews/frontend && npx tsc --noEmit 2>&1 | head -20
```

Spot-checks:
```bash
grep -n '"bot"' C:/Projects/StockNews/frontend/src/hooks/useSocket.ts
grep -n "subscribedRef.current.clear" C:/Projects/StockNews/frontend/src/hooks/useSocket.ts
grep -n "bot_status_update\|bot_trade_closed\|bot_signal_evaluated" C:/Projects/StockNews/frontend/src/hooks/useSocket.ts
grep -n "BotPanel" C:/Projects/StockNews/frontend/src/pages/Dashboard.tsx
grep -n "bot-1" C:/Projects/StockNews/frontend/src/store/dashboardStore.ts
```
All should return matches.
</verification>

<success_criteria>
- tsc --noEmit passes with zero errors in the frontend
- "bot" channel is subscribed in useSocket.ts
- subscribedRef.current.clear() is called before subscribeChannels() on reconnect
- Three bot WS message handlers exist in handleMessage
- Dashboard.tsx has BotPanel import and case "bot"
- dashboardStore.ts DEFAULT_PANELS has a bot-1 entry of type "bot"
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-bot-dashboard/05-03-SUMMARY.md` using the summary template.
</output>
