---
phase: 06-live-trading-mode
plan: "06-02"
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - frontend/src/components/panels/BotPanel.tsx
autonomous: true
requirements:
  - LIVE-02
  - LIVE-03

must_haves:
  truths:
    - "BotPanel has showLiveConfirm state and liveGate state"
    - "A 'Switch to LIVE' button appears in the status tab when mode is 'paper' and bot is stopped"
    - "Clicking 'Switch to LIVE' fetches GET /api/bot/gate and opens the inline confirmation panel"
    - "Confirmation panel displays all three gate criteria with pass/fail indicators"
    - "CONFIRM LIVE button is disabled when gate.passed is false"
    - "Successful mode switch calls GET /api/bot/status and updates the displayed mode badge"
    - "CANCEL button dismisses the confirmation panel without any API call"
    - "A 'Switch to PAPER' button appears when mode is 'live' and bot is stopped"
    - "Frontend tsc --noEmit passes with zero errors"
  artifacts:
    - frontend/src/components/panels/BotPanel.tsx
  key_links:
    - "Plan 06-01 creates POST /api/bot/mode and GET /api/bot/gate — both consumed here"
    - "Re-fetch GET /api/bot/status after successful mode switch to update the mode badge (Pitfall 3)"
---

<objective>
Add the live-mode confirmation dialog and gate status display to BotPanel.tsx.

Purpose: LIVE-02 requires an explicit user confirmation before switching to live mode and the switch must be blocked when positions are open. LIVE-03 requires the UI to show go-live gate progress. This plan wires the two routes from Plan 06-01 into the existing BotPanel component using the established inline-state pattern (same approach as the draft/saving/saveError config flow already in the component).

Output:
- `frontend/src/components/panels/BotPanel.tsx` — gate status + inline confirmation dialog + mode switch calls
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/06-live-trading-mode/06-RESEARCH.md

<interfaces>
<!-- Key contracts the executor needs. -->

From backend/src/services/goLiveGate.ts (created in Plan 06-01):
```typescript
export interface GoLiveGate {
  passed: boolean;
  tradeCount: number;
  tradeCountMet: boolean;
  winRate: number;
  winRateMet: boolean;
  cleanDays: number;
  cleanDaysMet: boolean;
  blockingReason: string | null;
}
// GET /api/bot/gate returns GoLiveGate JSON
// POST /api/bot/mode body: { mode: 'paper' | 'live' }
//   - 403 if gate not satisfied (paper→live only)
//   - 400 if positions are open
//   - 200 { mode } on success
```

From frontend/src/components/panels/BotPanel.tsx (existing state — add alongside these):
```typescript
const [tab, setTab] = useState<BotTab>("status");
const [draft, setDraft] = useState<BotConfig | null>(null);
const [saveError, setSaveError] = useState<string | null>(null);
const [saving, setSaving] = useState(false);
// ADD: showLiveConfirm, liveGate, liveGateLoading, modeSwitchError

const token = useAuthStore((s) => s.token);
const { status, setStatus, ... } = useBotStore();
```

BotPanel header (existing mode display — mode badge already here):
```tsx
{status && (
  <span className="text-[9px] text-muted font-mono">{status.mode.toUpperCase()}</span>
)}
```

Status tab (existing stats section — mode switch button goes BELOW the stats row, BEFORE the open positions section):
```tsx
{tab === "status" && (
  <div>
    {/* Stats row — existing */}
    {status && (
      <div className="px-2 py-2 border-b border-border space-y-1">
        {/* P&L Today, Trades Today, Open Positions, PDT rows */}
      </div>
    )}
    {/* MODE SWITCH SECTION — ADD HERE */}
    {/* Open positions label + list — existing */}
  </div>
)}
```

Existing botAction() pattern for reference:
```typescript
async function botAction(path: string) {
  if (!token) return;
  const res = await fetch(`/api/bot/${path}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
  });
  if (res.ok) {
    const data = (await res.json()) as { state: string };
    if (status) setStatus({ ...status, state: data.state as ... });
  }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode-switch state, handlers, and UI to BotPanel.tsx</name>
  <files>frontend/src/components/panels/BotPanel.tsx</files>
  <action>
Open `frontend/src/components/panels/BotPanel.tsx`. Read the full file before editing.

Make the following additions (do NOT remove or restructure any existing code):

**A. Add a GoLiveGate type definition** near the top of the file, after the existing imports:

```typescript
// ── Go-live gate type (mirrors backend GoLiveGate interface) ──────────────────
interface GoLiveGate {
  passed: boolean;
  tradeCount: number;
  tradeCountMet: boolean;
  winRate: number;
  winRateMet: boolean;
  cleanDays: number;
  cleanDaysMet: boolean;
  blockingReason: string | null;
}
```

**B. Add four new state variables** inside BotPanel(), immediately after the existing four state declarations (`tab`, `draft`, `saveError`, `saving`):

```typescript
const [showLiveConfirm, setShowLiveConfirm] = useState(false);
const [liveGate, setLiveGate] = useState<GoLiveGate | null>(null);
const [liveGateLoading, setLiveGateLoading] = useState(false);
const [modeSwitchError, setModeSwitchError] = useState<string | null>(null);
```

**C. Add two handler functions** inside BotPanel(), after the existing `handleSave()` function:

```typescript
// ── Fetch gate status and open the live-mode confirmation dialog ──────────────
async function openLiveConfirm() {
  if (!token) return;
  setModeSwitchError(null);
  setShowLiveConfirm(true);
  setLiveGateLoading(true);
  try {
    const res = await fetch("/api/bot/gate", {
      headers: { Authorization: `Bearer ${token}` },
    });
    const gate = (await res.json()) as GoLiveGate;
    setLiveGate(gate);
  } catch {
    setModeSwitchError("Failed to load gate status");
  } finally {
    setLiveGateLoading(false);
  }
}

// ── Call POST /api/bot/mode with the target mode ──────────────────────────────
async function handleModeSwitch(targetMode: "live" | "paper") {
  if (!token) return;
  setModeSwitchError(null);
  try {
    const res = await fetch("/api/bot/mode", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ mode: targetMode }),
    });
    if (res.ok) {
      setShowLiveConfirm(false);
      setLiveGate(null);
      // Re-fetch status to update the mode badge in the header (Pitfall 3 avoidance)
      if (status) {
        const s = await fetch("/api/bot/status", {
          headers: { Authorization: `Bearer ${token}` },
        }).then((r) => r.json()) as typeof status & { error?: string };
        if (s && !s.error) setStatus(s);
      }
    } else {
      const err = (await res.json()) as { error?: string };
      setModeSwitchError(err.error ?? "Mode switch failed");
    }
  } catch {
    setModeSwitchError("Network error");
  }
}
```

**D. Add the mode-switch section** inside the status tab's JSX. Insert it BETWEEN the closing `</div>` of the stats row block and the opening `<div className="px-2 py-1 border-b border-border">` of the "Open Positions" label.

The stats block ends with:
```tsx
            )}

            {/* Open positions */}
```

Insert before the `{/* Open positions */}` comment:

```tsx
            {/* Mode switch — only visible when bot is stopped */}
            {status && state === "stopped" && (
              <div className="px-2 py-2 border-b border-border">
                {/* Switch TO LIVE button */}
                {status.mode === "paper" && !showLiveConfirm && (
                  <button
                    onClick={() => void openLiveConfirm()}
                    className="w-full text-[10px] px-2 py-1 rounded border border-yellow-600/50 bg-yellow-500/5 text-yellow-400 hover:bg-yellow-500/10 font-mono"
                  >
                    Switch to LIVE Trading
                  </button>
                )}

                {/* Switch BACK TO PAPER button */}
                {status.mode === "live" && !showLiveConfirm && (
                  <button
                    onClick={() => void handleModeSwitch("paper")}
                    className="w-full text-[10px] px-2 py-1 rounded border border-border bg-surface text-muted hover:text-white font-mono"
                  >
                    Switch to PAPER
                  </button>
                )}

                {/* Inline live-mode confirmation panel */}
                {showLiveConfirm && (
                  <div className="border border-red-600/50 bg-red-500/5 rounded p-2 space-y-2">
                    <div className="text-[10px] font-mono text-red-400 font-semibold tracking-wide">
                      SWITCH TO LIVE TRADING?
                    </div>

                    {liveGateLoading && (
                      <div className="text-muted text-[10px] font-mono">Checking gate...</div>
                    )}

                    {!liveGateLoading && liveGate && (
                      <div className="space-y-1">
                        <div className="flex justify-between text-[10px] font-mono">
                          <span className="text-muted">Completed trades</span>
                          <span className={liveGate.tradeCountMet ? "text-up" : "text-down"}>
                            {liveGate.tradeCount}/30 {liveGate.tradeCountMet ? "✓" : "✗"}
                          </span>
                        </div>
                        <div className="flex justify-between text-[10px] font-mono">
                          <span className="text-muted">Win rate</span>
                          <span className={liveGate.winRateMet ? "text-up" : "text-down"}>
                            {(liveGate.winRate * 100).toFixed(1)}% / 40% {liveGate.winRateMet ? "✓" : "✗"}
                          </span>
                        </div>
                        <div className="flex justify-between text-[10px] font-mono">
                          <span className="text-muted">Clean days</span>
                          <span className={liveGate.cleanDaysMet ? "text-up" : "text-down"}>
                            {liveGate.cleanDays}/5 {liveGate.cleanDaysMet ? "✓" : "✗"}
                          </span>
                        </div>
                        {!liveGate.passed && liveGate.blockingReason && (
                          <div className="text-[9px] text-red-400/80 font-mono mt-1">
                            {liveGate.blockingReason}
                          </div>
                        )}
                      </div>
                    )}

                    {modeSwitchError && (
                      <div className="text-[9px] text-down font-mono">{modeSwitchError}</div>
                    )}

                    <div className="flex gap-2 pt-1">
                      <button
                        onClick={() => void handleModeSwitch("live")}
                        disabled={!liveGate?.passed || liveGateLoading}
                        className="flex-1 text-[10px] px-2 py-1 rounded border border-red-600/50 bg-red-500/10 text-red-400 hover:bg-red-500/20 font-mono disabled:opacity-40 disabled:cursor-not-allowed"
                      >
                        CONFIRM LIVE
                      </button>
                      <button
                        onClick={() => { setShowLiveConfirm(false); setModeSwitchError(null); }}
                        className="flex-1 text-[10px] px-2 py-1 rounded border border-border bg-surface text-muted hover:text-white font-mono"
                      >
                        CANCEL
                      </button>
                    </div>
                  </div>
                )}

                {/* Mode switch error outside dialog (live→paper errors) */}
                {modeSwitchError && !showLiveConfirm && (
                  <div className="text-[9px] text-down font-mono mt-1">{modeSwitchError}</div>
                )}
              </div>
            )}
```

After editing, run frontend tsc --noEmit to confirm zero TypeScript errors.
  </action>
  <verify>
    <automated>cd C:/Projects/StockNews/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>BotPanel.tsx compiles with zero TypeScript errors. showLiveConfirm, liveGate, liveGateLoading, and modeSwitchError state variables exist. handleModeSwitch() and openLiveConfirm() functions exist. Mode switch section renders in the status tab only when state === "stopped". Gate criteria display is present in the confirmation panel. CONFIRM LIVE button is disabled when gate.passed is false.</done>
</task>

</tasks>

<verification>
Run after task completes:
```bash
cd C:/Projects/StockNews/frontend && npx tsc --noEmit 2>&1 | head -20
```
Expected: no TypeScript errors.

Confirm state variables exist:
```bash
grep -n "showLiveConfirm\|liveGate\|liveGateLoading\|modeSwitchError\|handleModeSwitch\|openLiveConfirm" C:/Projects/StockNews/frontend/src/components/panels/BotPanel.tsx
```
Expected: multiple matches — at least state declarations, function definitions, and JSX usages.

Confirm gate display exists:
```bash
grep -n "CONFIRM LIVE\|SWITCH TO LIVE\|tradeCountMet\|winRateMet\|cleanDaysMet" C:/Projects/StockNews/frontend/src/components/panels/BotPanel.tsx
```
Expected: matches for all gate field renders.
</verification>

<success_criteria>
- BotPanel.tsx compiles with zero TypeScript errors
- GoLiveGate interface defined locally in BotPanel.tsx
- showLiveConfirm, liveGate, liveGateLoading, modeSwitchError state variables added
- openLiveConfirm() fetches GET /api/bot/gate and shows the inline dialog
- handleModeSwitch(targetMode) calls POST /api/bot/mode and re-fetches status on success
- Mode switch section only visible when state === "stopped"
- "Switch to LIVE Trading" button shows when mode === "paper" and !showLiveConfirm
- "Switch to PAPER" button shows when mode === "live" and !showLiveConfirm
- Confirmation dialog shows all three gate criteria with pass/fail indicators
- CONFIRM LIVE button disabled when gate not passed or loading
- CANCEL button clears showLiveConfirm without any API call
</success_criteria>

<output>
After completion, create `.planning/phases/06-live-trading-mode/06-02-SUMMARY.md` using the summary template.
</output>
