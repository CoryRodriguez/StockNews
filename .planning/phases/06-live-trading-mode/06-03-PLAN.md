---
phase: 06-live-trading-mode
plan: "06-03"
type: execute
wave: 3
depends_on:
  - "06-01"
  - "06-02"
autonomous: false
requirements:
  - LIVE-01
  - LIVE-02
  - LIVE-03

must_haves:
  truths:
    - "All automated checks pass (tsc, file existence, grep patterns)"
    - "LIVE-01: getAlpacaBaseUrl() returns live URL when mode=live and paper URL when mode=paper"
    - "LIVE-01: POST /api/bot/mode route exists and calls switchMode()"
    - "LIVE-02: POST /mode gate check only runs for paper→live direction"
    - "LIVE-02: showLiveConfirm state and CONFIRM LIVE button exist in BotPanel"
    - "LIVE-03: goLiveGate.ts evaluates all three gate criteria (tradeCount, winRate, cleanDays)"
    - "LIVE-03: GET /api/bot/gate route exists"
    - "LIVE-03: Gate criteria display exists in BotPanel"
    - "Human visually confirms mode switch UI appears correctly in the browser"
  artifacts:
    - .planning/phases/06-live-trading-mode/06-03-SUMMARY.md
    - .planning/phases/06-live-trading-mode/phase06-checks.sh
  key_links:
    - "Phase 6 complete → all LIVE-01, LIVE-02, LIVE-03 requirements delivered"

user_setup:
  - service: alpaca_live
    why: "Live trading requires Alpaca live account API credentials — distinct from paper account keys"
    env_vars:
      - name: ALPACA_API_KEY
        source: "Alpaca Dashboard (live account) -> API Keys -> Live. Replace the current paper key."
      - name: ALPACA_API_SECRET
        source: "Alpaca Dashboard (live account) -> API Keys -> Live. Replace the current paper secret."
    dashboard_config:
      - task: "Update ALPACA_API_KEY and ALPACA_API_SECRET in backend/.env (local) and in /opt/stocknews docker-compose.yml on VPS before switching to live mode"
        location: "backend/.env + VPS docker-compose.yml — both must use the live account keys simultaneously"
---

<objective>
Run automated verification across all Phase 6 deliverables and present the live-mode confirmation UI to the user for visual approval.

Purpose: Confirm that LIVE-01, LIVE-02, and LIVE-03 are fully implemented and integrated before marking Phase 6 complete. The automated checks verify TypeScript compilation, file existence, route wiring, and key code patterns. The human checkpoint confirms the mode-switch UI looks correct in the browser.

Output:
- phase06-checks.sh — automated verification script
- Human visual approval of live-mode UI
- 06-03-SUMMARY.md
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/06-live-trading-mode/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write and run automated verification suite</name>
  <files>.planning/phases/06-live-trading-mode/phase06-checks.sh</files>
  <action>
Create `.planning/phases/06-live-trading-mode/phase06-checks.sh` with the following content:

```bash
#!/usr/bin/env bash
# Phase 6: Live Trading Mode — Automated Verification Suite
# Run: bash .planning/phases/06-live-trading-mode/phase06-checks.sh

set -e
PASS=0
FAIL=0
ROOT="C:/Projects/StockNews"

check() {
  local desc="$1"
  local cmd="$2"
  if eval "$cmd" > /dev/null 2>&1; then
    echo "  PASS  $desc"
    PASS=$((PASS + 1))
  else
    echo "  FAIL  $desc"
    FAIL=$((FAIL + 1))
  fi
}

echo ""
echo "=== Phase 6: Live Trading Mode — Verification ==="
echo ""

# ── TypeScript compilation ──────────────────────────────────────────────────────
echo "── TypeScript ──"
check "Backend tsc --noEmit passes" \
  "cd '$ROOT/backend' && npx tsc --noEmit"
check "Frontend tsc --noEmit passes" \
  "cd '$ROOT/frontend' && npx tsc --noEmit"

# ── LIVE-01: Mode switching infrastructure ─────────────────────────────────────
echo ""
echo "── LIVE-01: Mode switching infrastructure ──"
check "getAlpacaBaseUrl() exists in botController.ts" \
  "grep -q 'getAlpacaBaseUrl' '$ROOT/backend/src/services/botController.ts'"
check "botController returns alpacaLiveUrl when mode=live" \
  "grep -q 'alpacaLiveUrl' '$ROOT/backend/src/services/botController.ts'"
check "switchMode exported from botController.ts" \
  "grep -q 'export.*switchMode\|switchMode.*export' '$ROOT/backend/src/services/botController.ts'"
check "switchMode imported in bot.ts" \
  "grep -q 'switchMode' '$ROOT/backend/src/routes/bot.ts'"
check "POST /mode route exists in bot.ts" \
  "grep -q \"router.post('/mode'\" '$ROOT/backend/src/routes/bot.ts'"

# ── LIVE-02: UI confirmation + open-position guard ────────────────────────────
echo ""
echo "── LIVE-02: UI confirmation + position guard ──"
check "evaluateGoLiveGate imported in bot.ts" \
  "grep -q 'evaluateGoLiveGate' '$ROOT/backend/src/routes/bot.ts'"
check "Gate check only runs for live direction (mode === 'live' guard)" \
  "grep -q \"mode === 'live'\" '$ROOT/backend/src/routes/bot.ts'"
check "switchMode called in /mode route" \
  "grep -q 'switchMode(mode' '$ROOT/backend/src/routes/bot.ts'"
check "showLiveConfirm state in BotPanel.tsx" \
  "grep -q 'showLiveConfirm' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "handleModeSwitch function in BotPanel.tsx" \
  "grep -q 'handleModeSwitch' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "CONFIRM LIVE button in BotPanel.tsx" \
  "grep -q 'CONFIRM LIVE' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "CANCEL button in BotPanel.tsx" \
  "grep -q 'CANCEL' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "Post to /api/bot/mode in BotPanel.tsx" \
  "grep -q '/api/bot/mode' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"

# ── LIVE-03: Go-live gate ─────────────────────────────────────────────────────
echo ""
echo "── LIVE-03: Go-live gate ──"
check "goLiveGate.ts service file exists" \
  "test -f '$ROOT/backend/src/services/goLiveGate.ts'"
check "GoLiveGate interface exported from goLiveGate.ts" \
  "grep -q 'export interface GoLiveGate' '$ROOT/backend/src/services/goLiveGate.ts'"
check "evaluateGoLiveGate function exported" \
  "grep -q 'export async function evaluateGoLiveGate' '$ROOT/backend/src/services/goLiveGate.ts'"
check "Gate checks trade count (GATE_MIN_TRADES)" \
  "grep -q 'GATE_MIN_TRADES' '$ROOT/backend/src/services/goLiveGate.ts'"
check "Gate checks win rate (GATE_MIN_WIN_RATE)" \
  "grep -q 'GATE_MIN_WIN_RATE' '$ROOT/backend/src/services/goLiveGate.ts'"
check "Gate checks clean days (GATE_MIN_CLEAN_DAYS)" \
  "grep -q 'GATE_MIN_CLEAN_DAYS' '$ROOT/backend/src/services/goLiveGate.ts'"
check "countConsecutiveBusinessDays helper exists" \
  "grep -q 'countConsecutiveBusinessDays' '$ROOT/backend/src/services/goLiveGate.ts'"
check "GET /gate route exists in bot.ts" \
  "grep -q \"router.get('/gate'\" '$ROOT/backend/src/routes/bot.ts'"
check "Gate display in BotPanel (tradeCountMet)" \
  "grep -q 'tradeCountMet' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "Gate display in BotPanel (winRateMet)" \
  "grep -q 'winRateMet' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "Gate display in BotPanel (cleanDaysMet)" \
  "grep -q 'cleanDaysMet' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "Gate fetch in BotPanel (GET /api/bot/gate)" \
  "grep -q '/api/bot/gate' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"
check "LIVE button disabled when gate not passed" \
  "grep -q 'liveGate?.passed\|liveGate.passed' '$ROOT/frontend/src/components/panels/BotPanel.tsx'"

# ── Summary ───────────────────────────────────────────────────────────────────
echo ""
echo "=== Results: $PASS passed, $FAIL failed ==="
if [ "$FAIL" -gt 0 ]; then
  echo "FAIL — $FAIL check(s) failed. Fix before marking Phase 6 complete."
  exit 1
else
  echo "PASS — All checks passed."
fi
```

After writing the script, run it:
```bash
bash "C:/Projects/StockNews/.planning/phases/06-live-trading-mode/phase06-checks.sh"
```

If any check fails, diagnose and fix the underlying issue in the appropriate file (goLiveGate.ts, bot.ts, or BotPanel.tsx). Do not mark this task done until all checks pass.
  </action>
  <verify>
    <automated>bash "C:/Projects/StockNews/.planning/phases/06-live-trading-mode/phase06-checks.sh"</automated>
  </verify>
  <done>phase06-checks.sh exists, runs to completion, and reports 0 failures. All LIVE-01, LIVE-02, and LIVE-03 pattern checks pass. Both tsc --noEmit checks pass.</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 2: Human visual verification of live-mode UI</name>
  <files></files>
  <action>
The automated checks have passed. Please verify the live-mode UI visually in the browser.

**What to check:**

1. Open the Bot Panel in the dashboard (the bot-1 panel).

2. Navigate to the **Status** tab.

3. Confirm the bot is in a "stopped" state. If not, click STOP.

4. **When mode is PAPER (default):**
   - You should see a "Switch to LIVE Trading" button below the PDT counter and above the "Open Positions" section.
   - Click "Switch to LIVE Trading".
   - An inline confirmation panel should appear showing:
     - Completed trades: [count]/30 with ✓/✗
     - Win rate: [pct]% / 40% with ✓/✗
     - Clean days: [count]/5 with ✓/✗
     - A blocking reason message if gate is not passed
     - A "CONFIRM LIVE" button (disabled/greyed if gate not met)
     - A "CANCEL" button
   - Click CANCEL — the panel should close.

5. **Confirm "Switch to LIVE" button does NOT appear when the bot is running or paused** (only visible when stopped).

6. **Note on LIVE mode testing:** You do NOT need to actually switch to live mode to approve this checkpoint. Visual confirmation of the dialog rendering correctly is sufficient. The gate criteria will show low counts (0 trades, 0% win rate, 0 clean days) since no paper trades have been executed yet — this is correct and expected behavior.

**Accept if:** The mode switch UI renders correctly, gate criteria display properly, and CANCEL dismisses the panel.
**Reject if:** The panel does not appear, or tsc errors were left unresolved.
  </action>
  <verify>
    <automated>bash "C:/Projects/StockNews/.planning/phases/06-live-trading-mode/phase06-checks.sh"</automated>
  </verify>
  <done>Human confirms: mode switch UI renders in the status tab when bot is stopped. Gate criteria display shows all three checks. CONFIRM LIVE is disabled when gate not met. CANCEL closes the dialog. Phase 6 is visually complete.</done>
</task>

</tasks>

<verification>
Final automated check:
```bash
bash "C:/Projects/StockNews/.planning/phases/06-live-trading-mode/phase06-checks.sh"
```
Expected: 0 failures, all checks PASS.

Confirm check count:
```bash
grep -c "^check " C:/Projects/StockNews/.planning/phases/06-live-trading-mode/phase06-checks.sh
```
Expected: 27+ check invocations.
</verification>

<success_criteria>
- phase06-checks.sh exists and all checks pass (0 failures)
- Backend tsc --noEmit passes
- Frontend tsc --noEmit passes
- All LIVE-01, LIVE-02, LIVE-03 grep pattern checks pass
- Human has visually confirmed the mode switch UI in the browser
- 06-03-SUMMARY.md created
- Phase 6 marked complete in .planning/STATE.md
</success_criteria>

<output>
After completion:
1. Create `.planning/phases/06-live-trading-mode/06-03-SUMMARY.md` using the summary template.
2. Update `.planning/STATE.md` — Phase 6 complete, milestone v1.0 COMPLETE.
3. Update `.planning/ROADMAP.md` — Phase 6 row: Plans 3/3 Complete, Status Complete, Completed 2026-03-01.
</output>
